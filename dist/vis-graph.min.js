"use strict";angular.module("visForDocreq").directive("visGraph",["visUtils","$timeout",function(e,t){return{restrict:"E",scope:{data:"=",settings:"=",height:"@"},template:'<div style="width:100%; height: {{height}}" id="__vistemplate"></div>',link:function(n){t(function(){e.setPathOrSelectionMode("selection")},1e3);var o=!0,i=$("#__vistemplate")[0],a=$("body");a.keydown(function(t){17===t.keyCode&&e.setPathOrSelectionMode("path",!0)}),a.keyup(function(t){17===t.keyCode&&e.setPathOrSelectionMode("selection",!0)}),n.$watch("data",function(t){o&&t?(e.redrawAll(n.data.edges,n.data.nodes,i,n.settings),o=!1):t&&e.updateData(n.data.edges,n.data.nodes)})}}}]),angular.module("visForDocreq").service("visUtils",function(){function e(e,t){for(var n=[],o=0;o<t.length;o++){var i=t[o];i.from===e&&n.push(i.to)}return n}function t(t){var a=u.get(),r=v.get(),f=!1;if(w=!1,p){for(var g=0;g<r.length;g++)r[g].inConnectionList=!1;if(!t.nodes[t.nodes.length-1]||b.length>2)b=[],l(a,r);else for(var m=0;m<a.length;m++)a[m].checked=!1,a[m].id===t.nodes[t.nodes.length-1]&&(a[m].inConnectionList=!0,b.push(a[m]));if(2===b.length){for(w=!0,f=!0,o(a),L=[],g=0;g<a.length;g++)S=0,C=[],"unchecked"===a[g].state&&i(a,r,a[g]);for(var k=[],g=0;g<L.length;g++)k.push({id:g,nodes:L[g],to:[]});for(var g=0;g<k.length;g++)for(var D=0;D<k[g].nodes.length;D++)for(var O=e(k[g].nodes[D].id,r),P=0;P<k.length;P++)if(P!==g)for(var U=0;U<k[P].nodes.length;U++)for(var I=0;I<O.length;I++)k[P].nodes[U].id===O[I]&&-1===$.inArray(P,k[g].to)&&k[g].to.push(P);for(var M,x,W=b[0].id,_=b[1].id,g=0;g<k.length;g++)for(var D=0;D<k[g].nodes.length;D++)k[g].nodes[D].id===W?M=g:k[g].nodes[D].id===_&&(x=g);n(M,x,k);for(var q=[],g=0;g<k.length;g++)if(k[g].highlight)for(var D=0;D<k[g].nodes.length;D++)for(var U=0;U<a.length;U++)a[U].id===k[g].nodes[D].id&&(q.push(a[U]),a[U].inConnectionList=!0);for(var U=0;U<q.length;U++)for(var g=0;g<r.length;g++)if(r[g].to===q[U].id)for(var D=0;D<q.length;D++)q[D].id===r[g].from&&(r[g].inConnectionList=!0);else if(r[g].from===q[U].id)for(var D=0;D<q.length;D++)q[D].id===r[g].to&&(r[g].inConnectionList=!0);y.setPathOrSelectionMode("selection",!1),b=[]}}else if(1!==t.nodes.length)l(a,r);else{f=!0;for(var g=0;g<r.length;g++)r[g].inConnectionList=r[g].from===t.nodes[0]||r[g].to===t.nodes[0];d(a);var z=h(t.nodes[0],r,!0);-1===z.indexOf(t.nodes[0])&&z.push(t.nodes[0]),s(z,a)}c(a,r,f),u.update(a),v.update(r)}function n(e,t,o){if(e===t)return o[e].highlight=!0,!0;for(var i=0;i<o[e].to.length;i++)n(o[e].to[i],t,o)&&(o[e].highlight=!0);return o[e].highlight}function o(e){for(var t=0;t<e.length;t++)e[t].state="unchecked"}function i(t,n,o){o.state="checked",S++,o.in=S,o.l=S,C.push(o),o.onStack=!0;for(var l=e(o.id,n),s=0;s<l.length;s++){var d=r(l[s],t);d.onStack?o.l=o.l>d.in?d.in:o.l:(i(t,n,d),o.l=o.l>d.l?d.l:o.l)}if(o.l===o.in){for(var h=[];C[C.length-1].id!==o.id;){var c=C.pop();c.onStack=!1,h.push(c)}var c=C.pop();c.onStack=!1,h.push(c),a(h)}o.state="finished",S++}function a(e){var t=!0;angular.forEach(L,function(n){if(n.length===e.length)for(var o=0;o<e.length;o++)n[0].id===e[o].id&&(t=!1)}),t&&L.push(e)}function r(e,t){for(var n=0;n<t.length;n++)if(t[n].id===e)return t[n];return null}function l(e,t){var n;for(n in e)e.hasOwnProperty(n)&&(f.useImage?e[n].image=f.imagePath+e[n].type+"-icon.png":e[n].color=f.colDefault,void 0!==e[n].oldLabel&&(e[n].label=e[n].oldLabel,e[n].oldLabel=void 0),e[n].levelOfSeperation=void 0,e[n].inConnectionList=void 0);for(var o=0;o<t.length;o++)t[o].color=f.colDefault,t[o].width=f.edgWidthDef,t[o].inConnectionList=!1}function s(e,t){for(var n=0;n<e.length;n++)for(var o=0;o<t.length;o++)t[o].id===e[n]&&(t[o].levelOfSeperation=1,t[o].inConnectionList=!0)}function d(e){for(var t in e)e.hasOwnProperty(t)&&(e[t].levelOfSeperation=void 0,e[t].inConnectionList=void 0)}function h(e,t,n){for(var o=[],i=0;i<t.length;i++){var a=t[i];a.to===e&&n&&-1===o.indexOf(a.from)?o.push(a.from):a.from===e&&-1===o.indexOf(a.to)&&o.push(a.to)}return o}function c(e,t,n){for(var o=0;o<e.length;o++)e[o].inConnectionList===!0?(f.useImage?e[o].image=f.imagePath+e[o].type+"-icon.png":e[o].color=f.colSelect,void 0!==e[o].oldLabel&&(e[o].label=e[o].oldLabel,e[o].oldLabel=void 0)):n?(f.useImage?e[o].image=f.imagePath+"blank.png":e[o].color=f.colUn,void 0===e[o].oldLabel&&(e[o].oldLabel=e[o].label,e[o].label="")):f.useImage?e[o].image=f.imagePath+e[o].type+"-icon.png":e[o].color=f.colDefault;for(var i=0;i<t.length;i++)t[i].inConnectionList?(t[i].color=f.colSelect,t[i].width=f.edgWidthDef):n?(t[i].color=f.colUn,t[i].width=f.edgWidthUn):(t[i].width=f.edgWidthUn,t[i].color=f.colDefault)}var f,g,u,v,p=!1,m=[],b=[],k=0,L=[],w=!1,y=this;y.redrawAll=function(e,n,o,i){function a(){0===k&&g.zoomExtent(!1),g.off("stabilized")}f=i,u=new vis.DataSet,v=new vis.DataSet;for(var r=[],l=[],s=0;s<e.length;s++)l.push({id:s,to:e[s].target,from:e[s].source});for(var d=0;d<n.length;d++)r.push({id:n[d].id,label:n[d].label,type:n[d].type}),m.push(n[d].id);if(f.useImage)for(var h=0;h<r.length;h++)switch(r[h].shape="image",r[h].image=f.imagePath+r[h].type+"-icon.png",r[h].type){case"Role":r[h].mass=20;break;case"BusinessTask":r[h].mass=10;break;case"Document":r[h].mass=5}else for(var c=0;c<r.length;c++)switch(r[c].type){case"Role":r[c].shape="star",r[c].mass=20;break;case"BusinessTask":r[c].shape="triangle",r[c].mass=10;break;case"Document":r[c].shape="square",r[c].mass=5}u.add(r),v.add(l);var p={nodes:u,edges:v};g=new vis.Network(o,p,f.options),g.on("stabilized",a),g.on("click",t),g.moveTo({scale:1e-41})},y.updateData=function(e,t){u.update(e),v.update(t)},y.setPathOrSelectionMode=function(e,t){if(!(!u&&!v||w&&t)&&("path"===e?(p=!0,b=[]):(p=!1,b=[]),t)){var n=u.get(),o=v.get();l(n,o),u.update(n),v.update(o)}};var S=0,C=[];return y});